<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-bottom: 100px; /* 为了给底部播放器留空间 */
        }
        #player {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #f8f9fa;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        #player img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-md-4">
                <input type="text" id="search-album-input" class="form-control" placeholder="Search for albums...">
            </div>
            <div class="col-md-4">
                <input type="text" id="search-artist-input" class="form-control" placeholder="Search for artists...">
            </div>
            <div class="col-md-4">
                <input type="text" id="search-song-input" class="form-control" placeholder="Search for songs...">
            </div>
        </div>
        <div id="content">
            <!-- 内容通过AJAX加载 -->
        </div>
    </div>
    <div id="player" class="d-none">
        <img id="current-album-cover" src="" alt="Album Cover">
        <div>
            <h5 id="current-song-title"></h5>
        </div>
        <div class="ml-auto">
            <audio controls id="audio-player" class="w-100">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            function loadAlbums() {
                $.getJSON('/get_albums', function (data) {
                    if (data.status === 'ok') {
                        var albumsHtml = '<div class="row">';
                        data.albums.forEach(function (album) {
                            albumsHtml += '<div class="col-md-3">';
                            albumsHtml += '<div class="card mb-4 shadow-sm">';
                            albumsHtml += `<img src="/cover/${album.coverArt}" class="card-img-top" alt="Album Cover">`;
                            albumsHtml += '<div class="card-body">';
                            albumsHtml += `<h5 class="card-title">${album.name}</h5>`;
                            albumsHtml += `<p class="card-text">${album.artist}</p>`;
                            albumsHtml += `<button class="btn btn-primary" onclick="loadAlbumDetails('${album.id}')">View Album</button>`;
                            albumsHtml += '</div>';
                            albumsHtml += '</div>';
                            albumsHtml += '</div>';
                        });
                        albumsHtml += '</div>';
                        $('#content').html(albumsHtml);
                    } else {
                        $('#content').html('<p>' + data.message + '</p>');
                    }
                });
            }

            function searchAlbums(query) {
                $.getJSON('/search', { query: query }, function (data) {
                    if (data.status === 'ok') {
                        var albumsHtml = '<div class="row">';
                        data.albums.forEach(function (album) {
                            albumsHtml += '<div class="col-md-3">';
                            albumsHtml += '<div class="card mb-4 shadow-sm">';
                            albumsHtml += `<img src="/cover/${album.coverArt}" class="card-img-top" alt="Album Cover">`;
                            albumsHtml += '<div class="card-body">';
                            albumsHtml += `<h5 class="card-title">${album.name}</h5>`;
                            albumsHtml += `<p class="card-text">${album.artist}</p>`;
                            albumsHtml += `<button class="btn btn-primary" onclick="loadAlbumDetails('${album.id}')">View Album</button>`;
                            albumsHtml += '</div>';
                            albumsHtml += '</div>';
                            albumsHtml += '</div>';
                        });
                        albumsHtml += '</div>';
                        $('#content').html(albumsHtml);
                    } else {
                        $('#content').html('<p>' + data.message + '</p>');
                    }
                });
            }

            function searchArtists(query) {
                $.getJSON('/search_artists', { query: query }, function (data) {
                    if (data.status === 'ok') {
                        var artistsHtml = '<div class="row">';
                        data.artists.forEach(function (artist) {
                            artistsHtml += '<div class="col-md-3">';
                            artistsHtml += '<div class="card mb-4 shadow-sm">';
                            artistsHtml += '<div class="card-body">';
                            artistsHtml += `<h5 class="card-title">${artist.name}</h5>`;
                            artistsHtml += `<button class="btn btn-primary" onclick="loadArtistDetails('${artist.id}')">View Artist</button>`;
                            artistsHtml += '</div>';
                            artistsHtml += '</div>';
                            artistsHtml += '</div>';
                        });
                        artistsHtml += '</div>';
                        $('#content').html(artistsHtml);
                    } else {
                        $('#content').html('<p>' + data.message + '</p>');
                    }
                });
            }

            function searchSongs(query) {
                $.getJSON('/search_songs', { query: query }, function (data) {
                    if (data.status === 'ok') {
                        var songsHtml = '<div class="row">';
                        data.songs.forEach(function (song) {
                            songsHtml += '<div class="col-md-3">';
                            songsHtml += '<div class="card mb-4 shadow-sm">';
                            songsHtml += '<div class="card-body">';
                            songsHtml += `<h5 class="card-title">${song.title}</h5>`;
                            songsHtml += `<p class="card-text">${song.artist}</p>`;
                            songsHtml += `<button class="btn btn-primary" onclick="playSong('${song.id}', '${song.title}', '${song.albumId}')">Play Song</button>`;
                            songsHtml += '</div>';
                            songsHtml += '</div>';
                            songsHtml += '</div>';
                        });
                        songsHtml += '</div>';
                        $('#content').html(songsHtml);
                    } else {
                        $('#content').html('<p>' + data.message + '</p>');
                    }
                });
            }

            window.loadAlbumDetails = function(albumId) {
                $.getJSON('/get_album_details/' + albumId, function (data) {
                    if (data.status === 'ok') {
                        var album = data.album;
                        var albumHtml = `<h1>${album.name}</h1>`;
                        albumHtml += `<p>Artist: ${album.artist}</p>`;
                        albumHtml += `<img src="/cover/${album.coverArt}" class="img-fluid mb-4" alt="Album Cover">`;
                        albumHtml += '<div class="list-group">';
                        album.song.forEach(function (song) {
                            albumHtml += `<button class="list-group-item list-group-item-action" onclick="playSong('${song.id}', '${song.title}', '${album.coverArt}')">${song.title}</button>`;
                        });
                        albumHtml += '</div>';
                        albumHtml += '<button class="btn btn-secondary mt-3" onclick="loadAlbums()">Back to Albums</button>';
                        $('#content').html(albumHtml);
                    } else {
                        $('#content').html('<p>' + data.message + '</p>');
                    }
                });
            };

            window.playSong = function(songId, songTitle, coverArtId) {
                $.getJSON('/play/' + songId, function (data) {
                    if (data.status === 'ok') {
                        $('#audio-player').attr('src', data.stream_url);
                        $('#current-song-title').text(songTitle);
                        $('#current-album-cover').attr('src', `/cover/${coverArtId}`);
                        $('#player').removeClass('d-none');
                        document.getElementById('audio-player').play();
                    } else {
                        alert('Failed to play song');
                    }
                });
            };

            // Initial load
            loadAlbums();

            // Expose loadAlbums globally
            window.loadAlbums = loadAlbums;

            // Search functionality
            $('#search-album-input').on('keyup', function () {
                var query = $(this).val();
                if (query.length > 2) {
                    searchAlbums(query);
                } else if (query.length === 0) {
                    loadAlbums();
                }
            });

            $('#search-artist-input').on('keyup', function () {
                var query = $(this).val();
                if (query.length > 2) {
                    searchArtists(query);
                } else if (query.length === 0) {
                    loadAlbums();
                }
            });

            $('#search-song-input').on('keyup', function () {
                var query = $(this).val();
                if (query.length > 2) {
                    searchSongs(query);
                } else if (query.length === 0) {
                    loadAlbums();
                }
            });
        });
    </script>
</body>
</html>
